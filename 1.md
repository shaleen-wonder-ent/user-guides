# AMPLS DNS Resolution - Explained in Simple English



## üìö Table of Contents
- [What is On-Premises DNS Server?](#what-is-on-premises-dns-server)
- [The Architecture Overview](#the-architecture-overview)
- [The Problem We're Solving](#the-problem-were-solving)
- [Option 1 Solution in Simple English](#option-1-solution-in-simple-english)
- [Step-by-Step Configuration](#step-by-step-configuration)
- [Real-Life Example Flows](#real-life-example-flows)
- [Testing Your Setup](#testing-your-setup)

## üè¢ What is On-Premises DNS Server?

The **On-Premises DNS Server** is the DNS server located in your physical office or data center - NOT in Azure cloud.

### Simple Explanation:
- **Location:** Your company's physical building/datacenter
- **Purpose:** Where all office computers go to translate names to IP addresses
- **Example IP:** 192.168.1.10 (as shown in diagram)
- **Common Types:** 
  - Windows Server with DNS role
  - Active Directory Domain Controller
  - Linux BIND server

### Think of it like:
> Your office has a "phone book" (DNS Server) that knows how to find everyone. When you want to call someone (access a website), you first check this phone book.

## üèóÔ∏è The Architecture Overview

Based on your diagram, here's what you have:

```yaml
Infrastructure Layout:
  On-Premises/LAN:
    - User PCs in office
    - 1 LAN DNS Server (192.168.1.10)
    - Connected to Azure via ExpressRoute/VPN
    
  Azure Cloud:
    Central India (CI) Region:
      - CI DNS VM 1 (10.1.0.4)
      - CI DNS VM 2 (10.1.0.5)
      - CI Log Analytics Workspace
      - CI Private DNS Zones
      
    South India (SI) Region:
      - SI DNS VM 1 (10.2.0.4)
      - SI DNS VM 2 (10.2.0.5)
      - SI Log Analytics Workspace
      - SI Private DNS Zones
```

## ‚ùå The Problem We're Solving

### Current Situation:
1. **CI DNS VMs** only know about CI resources (they can't resolve SI workspace addresses)
2. **SI DNS VMs** only know about SI resources (they can't resolve CI workspace addresses)
3. **Users in office** need to access BOTH CI and SI workspaces

### The Challenge:
```
User wants CI Workspace ‚Üí Asks LAN DNS ‚Üí LAN DNS asks SI DNS ‚Üí SI DNS doesn't know ‚Üí ‚ùå FAILS!
User wants SI Workspace ‚Üí Asks LAN DNS ‚Üí LAN DNS asks CI DNS ‚Üí CI DNS doesn't know ‚Üí ‚ùå FAILS!
```

## üí° Option 1 Solution in Simple English

### The Core Idea:
**"Teach each DNS server to forward queries it doesn't know to the right place"**

### How It Works - Like a Postal System:

1. **Office Post Office (LAN DNS Server)**
   - Knows: "All Azure mail goes to Azure sorting centers"
   - Action: Sends ALL Azure queries to ALL 4 Azure DNS servers

2. **SI Sorting Center (SI DNS VMs)**
   - Knows: "I handle SI addresses myself"
   - Also knows: "CI addresses? Forward to CI sorting center"

3. **CI Sorting Center (CI DNS VMs)**
   - Knows: "I handle CI addresses myself"
   - Also knows: "SI addresses? Forward to SI sorting center"

## üìã Step-by-Step Configuration

### Step 1: Configure LAN DNS Server (192.168.1.10)

**Location:** On-Premises/Office  
**What we're doing:** Teaching office DNS to send Azure queries to Azure

```powershell
# Run this on your LAN DNS Server (192.168.1.10)

# Tell it: "For Azure Monitor queries, ask all 4 Azure DNS servers"
Add-DnsServerConditionalForwarderZone `
    -Name "oms.opinsights.azure.com" `
    -MasterServers 10.1.0.4, 10.1.0.5, 10.2.0.4, 10.2.0.5

Add-DnsServerConditionalForwarderZone `
    -Name "ods.opinsights.azure.com" `
    -MasterServers 10.1.0.4, 10.1.0.5, 10.2.0.4, 10.2.0.5

Add-DnsServerConditionalForwarderZone `
    -Name "monitor.azure.com" `
    -MasterServers 10.1.0.4, 10.1.0.5, 10.2.0.4, 10.2.0.5
```

**In Simple Words:** 
> "Hey LAN DNS, when someone asks for anything ending in .opinsights.azure.com, forward the question to these 4 Azure DNS servers"

### Step 2: Configure CI DNS VMs (10.1.0.4 and 10.1.0.5)

**Location:** Azure CI Region  
**What we're doing:** Teaching CI DNS to forward SI queries to SI

```powershell
# Run this on BOTH CI DNS VMs (10.1.0.4 and 10.1.0.5)

# Get SI Workspace ID first (example)
$siWorkspaceId = "abc12345-1234-5678-9012-123456789012"

# Tell CI DNS: "If someone asks for SI workspace, forward to SI DNS"
Add-DnsServerConditionalForwarderZone `
    -Name "$siWorkspaceId.oms.opinsights.azure.com" `
    -MasterServers 10.2.0.4, 10.2.0.5

Add-DnsServerConditionalForwarderZone `
    -Name "$siWorkspaceId.ods.opinsights.azure.com" `
    -MasterServers 10.2.0.4, 10.2.0.5
```

**In Simple Words:**
> "Hey CI DNS, you don't know about SI workspace abc12345? Don't worry, just forward those queries to SI DNS servers at 10.2.0.4 and 10.2.0.5"

### Step 3: Configure SI DNS VMs (10.2.0.4 and 10.2.0.5)

**Location:** Azure SI Region  
**What we're doing:** Teaching SI DNS to forward CI queries to CI

```powershell
# Run this on BOTH SI DNS VMs (10.2.0.4 and 10.2.0.5)

# Get CI Workspace ID first (example)
$ciWorkspaceId = "def67890-5678-9012-3456-567890123456"

# Tell SI DNS: "If someone asks for CI workspace, forward to CI DNS"
Add-DnsServerConditionalForwarderZone `
    -Name "$ciWorkspaceId.oms.opinsights.azure.com" `
    -MasterServers 10.1.0.4, 10.1.0.5

Add-DnsServerConditionalForwarderZone `
    -Name "$ciWorkspaceId.ods.opinsights.azure.com" `
    -MasterServers 10.1.0.4, 10.1.0.5
```

**In Simple Words:**
> "Hey SI DNS, you don't know about CI workspace def67890? No problem, forward those queries to CI DNS servers at 10.1.0.4 and 10.1.0.5"

## üé¨ Real-Life Example Flows

### Example 1: User Accessing SI Workspace

```
Step 1: User types: abc12345.oms.opinsights.azure.com
Step 2: User's PC asks ‚Üí LAN DNS (192.168.1.10)
Step 3: LAN DNS asks ‚Üí SI DNS (10.2.0.4)
Step 4: SI DNS thinks ‚Üí "abc12345? That's mine! It's at 10.2.100.50"
Step 5: Response goes back ‚Üí SI DNS ‚Üí LAN DNS ‚Üí User's PC
Step 6: User connects to SI workspace successfully! ‚úÖ
```

### Example 2: User Accessing CI Workspace

```
Step 1: User types: def67890.oms.opinsights.azure.com
Step 2: User's PC asks ‚Üí LAN DNS (192.168.1.10)
Step 3: LAN DNS asks ‚Üí SI DNS (10.2.0.4) [Could be any of the 4]
Step 4: SI DNS thinks ‚Üí "def67890? Not mine, let me forward to CI DNS"
Step 5: SI DNS forwards ‚Üí CI DNS (10.1.0.4)
Step 6: CI DNS thinks ‚Üí "def67890? That's mine! It's at 10.1.100.60"
Step 7: Response goes back ‚Üí CI DNS ‚Üí SI DNS ‚Üí LAN DNS ‚Üí User's PC
Step 8: User connects to CI workspace successfully! ‚úÖ
```

## üß™ Testing Your Setup

### Quick Test from User's PC

```powershell
# Test from any office computer

# Test 1: Can I resolve SI workspace?
nslookup abc12345.oms.opinsights.azure.com
# Should return: 10.2.x.x (Private IP in SI range)

# Test 2: Can I resolve CI workspace?
nslookup def67890.oms.opinsights.azure.com
# Should return: 10.1.x.x (Private IP in CI range)

# Test 3: Check which DNS server answered
nslookup -debug abc12345.oms.opinsights.azure.com
```

### Detailed Test Script

```powershell
# Save as Test-Option1-DNS.ps1

Write-Host "=== Testing Option 1 DNS Configuration ===" -ForegroundColor Cyan

# Define workspaces
$siWorkspaceId = "abc12345-1234-5678-9012-123456789012"
$ciWorkspaceId = "def67890-5678-9012-3456-567890123456"

# Test SI Resolution
Write-Host "`nTesting SI Workspace Resolution..." -ForegroundColor Yellow
$siResult = Resolve-DnsName "$siWorkspaceId.oms.opinsights.azure.com" -ErrorAction SilentlyContinue
if ($siResult) {
    $ip = $siResult | Where {$_.Type -eq 'A'} | Select -First 1 -ExpandProperty IPAddress
    if ($ip -like "10.2.*") {
        Write-Host "‚úÖ SUCCESS: SI workspace resolves to SI Private IP: $ip" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è WARNING: SI workspace resolves to: $ip (expected 10.2.x.x)" -ForegroundColor Yellow
    }
} else {
    Write-Host "‚ùå FAILED: Cannot resolve SI workspace" -ForegroundColor Red
}

# Test CI Resolution
Write-Host "`nTesting CI Workspace Resolution..." -ForegroundColor Yellow
$ciResult = Resolve-DnsName "$ciWorkspaceId.oms.opinsights.azure.com" -ErrorAction SilentlyContinue
if ($ciResult) {
    $ip = $ciResult | Where {$_.Type -eq 'A'} | Select -First 1 -ExpandProperty IPAddress
    if ($ip -like "10.1.*") {
        Write-Host "‚úÖ SUCCESS: CI workspace resolves to CI Private IP: $ip" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è WARNING: CI workspace resolves to: $ip (expected 10.1.x.x)" -ForegroundColor Yellow
    }
} else {
    Write-Host "‚ùå FAILED: Cannot resolve CI workspace" -ForegroundColor Red
}

Write-Host "`n=== Test Complete ===" -ForegroundColor Cyan
```

## ‚úÖ Success Criteria

Your setup is working when:

1. ‚úÖ Users in office can resolve BOTH SI and CI workspace URLs
2. ‚úÖ SI workspace URLs resolve to 10.2.x.x IPs
3. ‚úÖ CI workspace URLs resolve to 10.1.x.x IPs
4. ‚úÖ No DNS timeouts or failures
5. ‚úÖ Users can actually connect to both workspaces

## üéØ Key Takeaways

1. **LAN DNS Server (192.168.1.10)** = The starting point for all queries from office
2. **Conditional Forwarders** = Rules that say "if someone asks for X, forward to Y"
3. **Cross-Region Forwarding** = SI DNS forwards CI queries to CI DNS (and vice versa)
4. **Why All 4 Servers?** = Redundancy - if one fails, others can answer

## üìù Summary in One Paragraph

This setup creates a "smart forwarding chain" where your office DNS server (192.168.1.10) forwards all Azure Monitor queries to all 4 Azure DNS servers. Each Azure DNS server is then configured to handle its own region's queries directly, but forward the other region's queries appropriately. SI DNS servers forward CI workspace queries to CI DNS servers, and CI DNS servers forward SI workspace queries to SI DNS servers. This ensures users can access workspaces in both regions without any DNS resolution failures.

---

**Remember:** The magic of this setup is that each DNS server knows exactly what to do with queries it receives - either answer them directly (if it's their region) or forward them to the right place (if it's the other region).
