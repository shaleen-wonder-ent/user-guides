# ✅ AKS – Vulnerability & Compliance Management Best Practices

## 1. Cluster and Node Security (Host / Worker / System Nodes)

| Area | Best Practices | Tools & Services |
|------|----------------|------------------|
| **Node OS Hardening** | - Use **Azure-managed node pools** (node images maintained by Microsoft).  <br> - Keep nodes updated by enabling **automatic node image upgrades**. <br> - For self-managed nodes, apply **Azure Linux / Mariner hardened images** and regular patching. | - `az aks update --enable-node-public-ip false` (disable public IPs) <br> - Azure Policy for AKS |
| **Cluster Configuration** | - Use **private clusters** to avoid exposing API server publicly. <br> - Restrict access with **Azure RBAC for Kubernetes**. <br> - Enable **audit logs** and **diagnostic settings**. | - Azure Policy <br> - Azure Monitor / Defender for Cloud |
| **Network Security** | - Use **Azure CNI + Network Policies (Calico)** for traffic control. <br> - Integrate with **Azure Firewall or NVA** for egress control. <br> - Use **Private Link** for AKS API and ACR. | - Azure CNI, Calico <br> - Azure Firewall <br> - NSGs / Route Tables |

---

## 2. Container and Image Security

| Area | Best Practices | Tools & Services |
|------|----------------|------------------|
| **Image Scanning** | - Store all images in **Azure Container Registry (ACR)**. <br> - Enable **Microsoft Defender for Containers** for continuous image scanning (detect CVEs). <br> - Implement **CI/CD gate** to block vulnerable images before push/deploy. | - Defender for Cloud (Container registry scanning) <br> - ACR Tasks (for automated build & scan) |
| **Image Source Control** | - Use only **trusted base images** (Microsoft, Red Hat UBI, Alpine, etc.). <br> - Sign images using **Notary v2 / cosign** for provenance. <br> - Regularly rebuild images to incorporate base image patches. | - `az acr task run` <br> - Sigstore / Cosign |
| **Runtime Protection** | - Use **read-only root filesystem**, disable privilege escalation, drop unnecessary Linux capabilities. <br> - Enforce **Pod Security Standards (Baseline / Restricted)**. <br> - Implement **Azure Policy for Kubernetes** for enforcement. | - Pod Security Admission <br> - Azure Policy add-on |

---

## 3. Compliance & Governance

| Area | Best Practices | Tools & Services |
|------|----------------|------------------|
| **Compliance Baselines** | - Map your AKS environment to **CIS Benchmark for Kubernetes** and **Azure Security Benchmark**. <br> - Use **Defender for Cloud regulatory compliance dashboard**. | - Microsoft Defender for Cloud <br> - Azure Policy regulatory compliance |
| **Policy Enforcement** | - Apply **Azure Policy for AKS** for continuous compliance (e.g., allowed container registries, disallow privileged containers). <br> - Enable **Policy Add-on for AKS**. | - Azure Policy <br> - Defender for Cloud |
| **Auditing & Monitoring** | - Enable **Azure Monitor for Containers** for performance and behavior monitoring. <br> - Integrate with **Log Analytics Workspace**. | - Azure Monitor <br> - Log Analytics <br> - Sentinel (for SIEM integration) |

---

## 4. Defender for Cloud Integration

**Microsoft Defender for Containers** (previously Defender for Kubernetes + ACR) provides end-to-end protection:
- **Image scanning** (ACR, CI/CD pipelines)
- **Runtime threat detection** (AKS workloads)
- **Kubernetes audit log analysis**
- **Compliance posture management** (CIS, NIST, ISO)

Enable at subscription level via:
```bash
az security pricing create -n KubernetesService --tier standard
az security pricing create -n ContainerRegistry --tier standard
```

---

## 5. Recommended Architecture Diagram

**High-level view**

```
[ Developers ]
     |
     v
[ CI/CD Pipeline ]
     |  (ACR Image Build + Scan)
     v
[ Azure Container Registry ] ----> Defender for Cloud Scan
     |
     v
[ AKS Cluster (Private) ]
  - System Node Pool (Hardened)
  - User Node Pool (Workload)
     |
     +--> Azure Policy
     +--> Defender for Containers
     +--> Azure Monitor / Sentinel
```

---

## 6. Key Microsoft Docs & References

- [AKS Security Baseline](https://learn.microsoft.com/azure/architecture/reference-architectures/containers/aks/secure-baseline-aks)  
- [Best practices for cluster security and upgrades](https://learn.microsoft.com/azure/aks/operator-best-practices-cluster-security)  
- [Microsoft Defender for Containers overview](https://learn.microsoft.com/azure/defender-for-cloud/defender-for-containers-introduction)  
- [Azure Policy samples for AKS](https://learn.microsoft.com/azure/governance/policy/samples/aks)
